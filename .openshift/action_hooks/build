#!/bin/bash
# This is a simple build script and will be executed on your CI system if 
# available.  Otherwise it will execute while your application is stopped
# before the deploy step.  This script gets executed directly, so it
# could be python, php, ruby, etc.

FORCE_BUILD=false               # set to true to force build
VERSION=LATEST

# Determine whether we're getting a release or an incremental 
if [[ ${VERSION} =~ \. ]]; then
    # Official release, e.g. 0.9.0
    URL=http://repository-projectodd.forge.cloudbees.com/release/org/immutant/immutant-dist/${VERSION}/immutant-dist-${VERSION}-bin.zip
else
    # Incremental build, e.g. 999 or LATEST
    URL=http://repository-projectodd.forge.cloudbees.com/incremental/immutant/${VERSION}/immutant-dist-bin.zip
fi

cd ${OPENSHIFT_DATA_DIR}

if [[ ${FORCE_BUILD} == true ]]; then
    rm -f immutant
fi

# Download/explode the dist and symlink it to immutant
if [ ! -d immutant ]; then
    rm -rf immutant*
    wget -nv ${URL}
    unzip -q immutant-dist-*.zip
    rm immutant-dist-*.zip
    ln -s immutant-* immutant
fi

# Create deployment descriptor for the app
DD=${OPENSHIFT_REPO_DIR}/deployments/${OPENSHIFT_APP_NAME}.clj
if [ ! -f ${DD} ]; then
    echo "{:root \"${OPENSHIFT_REPO_DIR}\" :context-path \"/\"}" > ${DD}
fi
> ${DD}.dodeploy
